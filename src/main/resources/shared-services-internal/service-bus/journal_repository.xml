<?xml version="1.0" encoding="UTF-8"?>
<specification xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
               xmlns="https://magento.com/open-specification"
               xsi:schemaLocation="https://magento.com/open-specification ../specification.xsd">

    <module name="magento.service_bus">

        <service name="journal_repository">
            <summary>Journal Repository</summary>
            <description>Provides API for fetching delivery journal of MOM integration layer.</description>
            <query name="search_attempts">
                <summary>Query journal for message transport attempts</summary>
                <extensible>false</extensible>
                <status>public</status>
                <arguments>
                    <argument name="query">
                        <summary>Query</summary>
                        <type>magento.common.query</type>
                        <required>false</required>
                    </argument>
                </arguments>
                <returns>magento.service_bus.delivery_attempt_collection</returns>
                <searchable_fields>
                    <field name="timestamp">
                        <summary>Timestamp of event</summary>
                        <type>datetime</type>
                    </field>
                    <field name="delivery_id">
                        <summary>Unique delivery attempt id</summary>
                    </field>
                    <field name="vhost">
                        <summary>Client identification</summary>
                    </field>
                    <field name="endpoint">
                        <summary>Integration name where this attempt is addressed to</summary>
                    </field>
                    <field name="method">
                        <summary>JSONRPC method</summary>
                    </field>
                    <field name="response">
                        <summary>Result payload</summary>
                    </field>
                    <field name="delivered">
                        <summary>Flag whether the attempt was delivered</summary>
                        <type>boolean</type>
                    </field>
                    <field name="ok">
                        <summary>Flag whether the attempt resulted in success</summary>
                        <type>boolean</type>
                    </field>
                    <field name="is_retry">
                        <summary>Flag whether this is a retry attempt</summary>
                        <type>boolean</type>
                    </field>
                    <field name="error_message">
                        <summary>JSONRPC error text</summary>
                    </field>
                    <field name="latency">
                        <summary>HTTP request duration in miliseconds</summary>
                        <type>integer</type>
                    </field>
                    <field name="host">
                        <summary>Hostname of the instance where this attempt is being processed</summary>
                    </field>
                    <field name="client_ip">
                        <summary>IP address where the requests comes from</summary>
                    </field>
                </searchable_fields>
            </query>

            <query name="search_messages">
                <summary>Query journal for messages</summary>
                <extensible>false</extensible>
                <status>beta</status>
                <arguments>
                    <argument name="query">
                        <summary>Query</summary>
                        <type>magento.common.query</type>
                        <required>false</required>
                    </argument>
                </arguments>
                <returns>magento.service_bus.message_collection</returns>
            </query>

            <query name="get_methods">
                <summary>Query journal for a list of transported message methods</summary>
                <extensible>false</extensible>
                <status>draft</status>
                <arguments />
                <returns>array[string]</returns>
            </query>
        </service>

        <struct name="message_collection">
            <summary>Message collection</summary>
            <extensible>false</extensible>
            <properties>
                <property name="offset">
                    <summary>Offset</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="size">
                    <summary>Size</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="total">
                    <summary>Total</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="items">
                    <summary>Items</summary>
                    <type>array[magento.service_bus.message]</type>
                    <required>false</required>
                </property>
            </properties>
        </struct>

        <struct name="message">
            <summary>Message</summary>
            <extensible>false</extensible>
            <properties>
                <property name="delivery_id">
                    <summary>Unique ID for Message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="received_at">
                    <summary>Time when message was received</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="endpoint">
                    <summary>Endpoint</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="method">
                    <summary>Method</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="params">
                    <summary>JSON serialized parameters</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="status">
                    <summary>Status</summary>
                    <description>
                        Possible statuses:
                        - delivering - message received and yet not delivered to integration
                        - success - message successfully received by integration
                        - error - message delivered to integration but integration replied with an error response
                        - failure - message was not delivered to integration
                    </description>
                    <type>magento.service_bus.message_status</type>
                    <required>false</required>
                </property>
                <property name="host">
                    <summary>Host which received message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="client_ip">
                    <summary>Client IP which sent the message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
            </properties>
        </struct>

        <struct name="delivery_attempt_collection">
            <summary>Delivery Attempt collection</summary>
            <extensible>false</extensible>
            <properties>
                <property name="offset">
                    <summary>Offset</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="size">
                    <summary>Size</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="total">
                    <summary>Total</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="items">
                    <summary>Items</summary>
                    <type>array[magento.service_bus.delivery_attempt]</type>
                    <required>false</required>
                </property>
            </properties>
        </struct>

        <struct name="delivery_attempt">
            <summary>Delivery Attempt</summary>
            <extensible>false</extensible>
            <properties>
                <property name="delivery_id">
                    <summary>Unique ID for Message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="sent_at">
                    <summary>Time when attempt was sent</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="endpoint">
                    <summary>Endpoint</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="method">
                    <summary>Method</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="response">
                    <summary>Response Body</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="error_message">
                    <summary>Error Message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="is_delivered">
                    <summary>Flag if attempt could reach the server</summary>
                    <type>boolean</type>
                    <required>false</required>
                </property>
                <property name="is_retry">
                    <summary>Flag if attempt is a retry</summary>
                    <type>boolean</type>
                    <required>false</required>
                </property>
                <property name="latency">
                    <summary>Amount of time request took (in ms)</summary>
                    <type>integer</type>
                    <required>false</required>
                </property>
                <property name="host">
                    <summary>Host which made the attempt</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
                <property name="client_ip">
                    <summary>Client IP which sent the initial message</summary>
                    <type>string</type>
                    <required>false</required>
                </property>
            </properties>
        </struct>

        <enum name="message_status">
            <value>delivering</value>
            <value>success</value>
            <value>error</value>
            <value>failure</value>
        </enum>
    </module>
</specification>
